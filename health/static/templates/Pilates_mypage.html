{% extends "navbar.html" %}
{% load humanize %}
{% block content %}
<h2 class="text-center"><span class="header">{{staff}}의 My page</span></h2>
<hr/>
<div class="col-xs-8 col-xs-offset-2">

<div class="btn btn-default">전체</div>
{{PT_members.count}}명

<div class="btn btn-default">오늘</div>
{{today_members.count}}명
<span>{{today_members_pay |intcomma}}원</span>

<div class="btn btn-default">이번주</div>
{{thisweek_members.count}}명
<span>{{thisweek_members_pay |intcomma}}원</span>

<div class="btn btn-default">이번달</div>
<span>{{thismonth_members.count}}명</span>
<span>{{thismonth_members_pay |intcomma}}원</span>


{% if request.user.is_superuser %}
<div class="btn btn-danger" data-toggle="modal" data-target="#save" style="float:right;">지난 달 저장</div>
{% else %}
{% endif %}
<hr/>

<div class="text-center" style="display: inline-block;">
<a class="btn btn-success">지난달 Pilates팀 총 매출</a>
<p> </p>
<p><span class="team_sales">{{last_team_sales |intcomma}}</span>원</p>
</div>

<div class="text-center" style="display: inline-block;">
<a class="btn btn-success">지난달 나의 총 매출</a>
<p> </p>
<p><span class="personal_sales">{{lastmonth_members_pay |intcomma}}</span>원</p>
</div>

<hr/>
<div class="text-center" style="display: inline-block;">
<a class="btn btn-warning">지난달 기본급</a>
<p><span class="basic_salary">{{basic_salary |intcomma}}</span>원</p>
</div>


{% if staff.teamleader %}
<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 커미션</div>
<p>(<span class="commission_rate">{{ last_commission_rate }}</span>%) / <span class="commission">{{ last_commission |intcomma }}</span>원</p>
</div>
{% else %}
{% endif %}

<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 GX 수업료</div>
<p><span>({{ lastmonth_GX_schedules }}</span>번) / <span class="GX_commission">{{ last_GX_commission |intcomma}}</span>원</p>
</div>

<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 PT 수업료</div>
{% if staff.teamleader %}
    <p><span>{{ lastmonth_PT_schedules }}명</span>
{% else %}
    <p><span class="PT_commission_rate">{{ last_PT_commission_rate }}</span>%
{% endif %}
    <span class="PT_commission">{{ last_PT_commission |intcomma}}</span>원</p>
</div>

<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 총합계</div>
<p><span class="total">{{ last_total |intcomma}}</span>원</p>
</div>

<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 환불</div>
<p><span class="refund">0</span>원</p>
</div>

<div class="text-center" style="display: inline-block;">
<div class="btn btn-warning">지난달 월급</div>
<p><span class="salary">{{ last_total |intcomma}}</span>원</p>
</div>

<hr>

<div class="btn btn-primary">이번달 기본급</div>
<span>{{ basic_salary |intcomma}}원</span>


{% if staff.teamleader %}
<div class="btn btn-primary">이번달 커미션</div>
<span>{{this_commission_rate}}%</span>
<span>{{this_commission |intcomma}}원</span>
{% else %}
{% endif %}


<div class="btn btn-primary">이번달 GX 수업료</div>
<span>{{ thismonth_GX_schedules }}번</span>
<span>{{ this_GX_commission |intcomma}}원</span>

<div class="btn btn-primary">이번달 PT 수업료</div>
{% if staff.teamleader %}
    <span>{{ thismonth_PT_schedules }}명</span>
{% else %}
    <span>{{ this_PT_commission_rate }}%</span>
{% endif %}
<span>{{ this_PT_commission |intcomma}}원</span>

<div class="btn btn-primary">이번달 총합계</div>
<span>{{ this_total |intcomma }}원</span>

<div class="btn btn-primary">이번달 환불</div>
<span>0원</span>

<div class="btn btn-primary">이번달 월급</div>
<span>{{ this_total |intcomma }}원</span>

<hr/>
<table class="table table-bordered">
    <tr>
        <th>이름</th>
        <th>환불일</th>
        <th>환불액</th>
        <th>삭감 커미션</th>
    </tr>
    <tr>
        <td>1</td>
        <td>2</td>
        <td>3</td>
        <td>4</td>
    </tr>
    <tr>
    <th colspan="3">환불 총합</th>
    <td>142</td>
    </tr>
</table>

</div>

<!-- Modal -->
    <div class="modal fade" id="save" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">저장</h4>
          </div>
          <div class="modal-body">
            정말 '{{staff}}'의 지난달 매출,월급을 저장하시겠습니까?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">아니오</button>
            <a type="button" class="save btn btn-danger"  data-dismiss="modal">예</a>
          </div>
        </div>
      </div>
    </div>

<script type="text/javascript">
    $('.save').unbind("click").bind("click", function(){
        commission_rate = $('.commission_rate').text();
        commission = $('.commission').text();

        if(commission_rate != "" ){ //빈값이면 팀원.
            alert("팀장임");
            PT_commission_rate = '0.0' //팀장은 pt 커미션 비율없음.
        }
        else{
            alert("팀원임")
            commission_rate = '0.0' //팀원은 커미션비율 없음.
            commission = '0'
            PT_commission_rate = $('.PT_commission_rate').text();
        }

        id = {{staff.id}}
        team_sales = $('.team_sales').text();
        personal_sales = $('.personal_sales').text();
        basic_salary = $('.basic_salary').text();

        GX_commission = $('.GX_commission').text();

        PT_commission = $('.PT_commission').text();
        total = $('.total').text();
        refund = $('.refund').text();
        salary = $('.salary').text();

        var allData = {'csrfmiddlewaretoken': '{{ csrf_token }}', "id":id, 'team_sales':team_sales, 'personal_sales':personal_sales, 'basic_salary':basic_salary, 'commission_rate':commission_rate, 'commission':commission, 'GX_commission':GX_commission,'PT_commission_rate':PT_commission_rate, 'PT_commission':PT_commission, 'total':total, 'refund':refund, 'salary':salary};
        $.ajax({
            url: "{% url 'authentication:pilates_salary_save' %}",
            type: "POST",
            data: allData,
            dataType: "json",

            success: function(response){
                alert("월급 저장 완료");
            },
            error: function(error){
                alert("실패");
            }
        });
    });
</script>
{% endblock %}